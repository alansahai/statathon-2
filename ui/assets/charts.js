/**
 * charts.js - Dynamic Chart Loading and Display
 * 
 * Provides utilities for loading and displaying charts generated by backend
 * Supports: histogram, boxplot, scatterplot, heatmap, and custom plots
 */

const ChartService = {
    /**
     * =====================================================
     * CHART LOADING FUNCTIONS
     * =====================================================
     */

    /**
     * Load chart image from backend path
     * @param {string} path - Relative path to chart image (e.g., "static/charts/plot_abc123.png")
     * @param {string} elementId - ID of img element to update
     * @param {Object} options - Display options
     */
    loadChartImage(path, elementId, options = {}) {
        const {
            alt = 'Chart',
            className = 'chart-image',
            fallbackSrc = null,
            onError = null
        } = options;

        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`Element with ID '${elementId}' not found`);
            return;
        }

        // Construct full URL using window.API_BASE
        // Remove leading slash if present to avoid double slashes
        const cleanPath = path.startsWith('/') ? path.substring(1) : path;
        const apiBase = window.API_BASE.replace('/api', '');
        const fullUrl = `${apiBase}/${cleanPath}`;

        // Update image element
        if (element.tagName === 'IMG') {
            element.src = fullUrl;
            element.alt = alt;
            element.className = className;

            // Add animation
            this.animateChart(elementId);

            // Handle loading errors
            element.onerror = () => {
                if (fallbackSrc) {
                    element.src = fallbackSrc;
                } else {
                    element.src = 'assets/images/chart-placeholder.png';
                    element.alt = 'Chart not available';
                }

                if (onError && typeof onError === 'function') {
                    onError(element);
                }
            };
        } else {
            // If element is a container, create img tag inside
            element.innerHTML = `
                <img src="${fullUrl}" 
                     alt="${alt}" 
                     class="${className} chart-container"
                     onerror="this.src='assets/images/chart-placeholder.png'">
            `;

            // Add animation
            this.animateChart(elementId);
        }
    },

    /**
     * Load multiple charts at once
     * @param {Array<Object>} charts - Array of {path, elementId, options}
     */
    loadCharts(charts) {
        charts.forEach(chart => {
            this.loadChartImage(chart.path, chart.elementId, chart.options || {});
        });
    },

    /**
     * =====================================================
     * CHART CONTAINERS
     * =====================================================
     */

    /**
     * Create chart container with title and description
     * @param {string} title - Chart title
     * @param {string} description - Chart description
     * @param {string} chartId - ID for chart img element
     * @returns {string} HTML string for chart container
     */
    createChartContainer(title, description, chartId) {
        return `
            <div class="card chart-card mb-4">
                <div class="card-header">
                    <h3 class="text-lg font-bold">${title}</h3>
                    ${description ? `<p class="text-sm text-gray-600 mt-1">${description}</p>` : ''}
                </div>
                <div class="card-body text-center">
                    <img id="${chartId}" 
                         class="chart-image mx-auto" 
                         alt="${title}"
                         style="max-width: 100%; height: auto;">
                </div>
            </div>
        `;
    },

    /**
     * Create grid layout for multiple charts
     * @param {Array<Object>} charts - Array of {title, description, chartId}
     * @param {number} columns - Number of columns (1-3)
     * @returns {string} HTML string for chart grid
     */
    createChartGrid(charts, columns = 2) {
        const gridClass = columns === 3 ? 'grid-cols-3' : columns === 1 ? 'grid-cols-1' : 'grid-cols-2';

        const chartContainers = charts.map(chart =>
            this.createChartContainer(chart.title, chart.description, chart.chartId)
        ).join('');

        return `
            <div class="grid ${gridClass} gap-6 mb-6">
                ${chartContainers}
            </div>
        `;
    },

    /**
     * =====================================================
     * SPECIFIC CHART TYPES
     * =====================================================
     */

    /**
     * Load histogram chart
     * @param {string} filePath - Path to histogram image
     * @param {string} containerId - Container element ID
     * @param {string} variable - Variable name
     */
    loadHistogram(filePath, containerId, variable = '') {
        const title = variable ? `Histogram - ${variable}` : 'Histogram';
        const description = 'Distribution of values';

        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = this.createChartContainer(title, description, `hist-${variable}`);
            this.loadChartImage(filePath, `hist-${variable}`);
        }
    },

    /**
     * Load boxplot chart
     * @param {string} filePath - Path to boxplot image
     * @param {string} containerId - Container element ID
     * @param {string} variable - Variable name
     */
    loadBoxplot(filePath, containerId, variable = '') {
        const title = variable ? `Boxplot - ${variable}` : 'Boxplot';
        const description = 'Distribution with quartiles and outliers';

        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = this.createChartContainer(title, description, `box-${variable}`);
            this.loadChartImage(filePath, `box-${variable}`);
        }
    },

    /**
     * Load scatterplot chart
     * @param {string} filePath - Path to scatterplot image
     * @param {string} containerId - Container element ID
     * @param {string} xVar - X-axis variable
     * @param {string} yVar - Y-axis variable
     */
    loadScatterplot(filePath, containerId, xVar = '', yVar = '') {
        const title = xVar && yVar ? `${xVar} vs ${yVar}` : 'Scatterplot';
        const description = 'Relationship between variables';

        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = this.createChartContainer(title, description, `scatter-${xVar}-${yVar}`);
            this.loadChartImage(filePath, `scatter-${xVar}-${yVar}`);
        }
    },

    /**
     * Load correlation heatmap
     * @param {string} filePath - Path to heatmap image
     * @param {string} containerId - Container element ID
     */
    loadHeatmap(filePath, containerId) {
        const title = 'Correlation Heatmap';
        const description = 'Correlation matrix between variables';

        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = this.createChartContainer(title, description, 'heatmap');
            this.loadChartImage(filePath, 'heatmap');
        }
    },

    /**
     * =====================================================
     * CHART GALLERY
     * =====================================================
     */

    /**
     * Create interactive chart gallery with tabs
     * @param {Object} charts - Object with chart types as keys and paths as values
     * @param {string} containerId - Container element ID
     */
    createChartGallery(charts, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const chartTypes = Object.keys(charts);
        if (chartTypes.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No charts available</p>';
            return;
        }

        // Create tabs
        const tabs = chartTypes.map((type, index) => `
            <button class="tab-button ${index === 0 ? 'active' : ''}" 
                    onclick="ChartService.switchTab('${type}', '${containerId}')"
                    id="tab-${type}">
                ${this.formatChartType(type)}
            </button>
        `).join('');

        // Create tab content
        const apiBase = window.API_BASE.replace('/api', '');
        const tabContents = chartTypes.map((type, index) => `
            <div class="tab-content ${index === 0 ? 'active' : ''}" 
                 id="content-${type}">
                <img src="${apiBase}/${charts[type]}" 
                     alt="${this.formatChartType(type)}"
                     class="chart-image mx-auto"
                     style="max-width: 100%; height: auto;">
            </div>
        `).join('');

        container.innerHTML = `
            <div class="chart-gallery card">
                <div class="tab-buttons">
                    ${tabs}
                </div>
                <div class="tab-contents card-body">
                    ${tabContents}
                </div>
            </div>
        `;
    },

    /**
     * Switch between tabs in chart gallery
     * @param {string} chartType - Chart type to show
     * @param {string} containerId - Container element ID
     */
    switchTab(chartType, containerId) {
        // Deactivate all tabs and contents
        const container = document.getElementById(containerId);
        if (!container) return;

        container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // Activate selected tab
        const tab = container.querySelector(`#tab-${chartType}`);
        const content = container.querySelector(`#content-${chartType}`);

        if (tab) tab.classList.add('active');
        if (content) content.classList.add('active');
    },

    /**
     * Format chart type name for display
     * @param {string} type - Chart type
     * @returns {string} Formatted name
     */
    formatChartType(type) {
        const typeMap = {
            'histogram': 'ðŸ“Š Histogram',
            'boxplot': 'ðŸ“¦ Boxplot',
            'scatterplot': 'ðŸ”µ Scatterplot',
            'heatmap': 'ðŸ”¥ Heatmap',
            'barplot': 'ðŸ“ˆ Bar Chart',
            'lineplot': 'ðŸ“‰ Line Chart',
            'pieplot': 'ðŸ¥§ Pie Chart',
            'violinplot': 'ðŸŽ» Violin Plot'
        };

        return typeMap[type] || type.charAt(0).toUpperCase() + type.slice(1);
    },

    /**
     * =====================================================
     * DOWNLOAD CHARTS
     * =====================================================
     */

    /**
     * Download chart as PNG
     * @param {string} chartPath - Path to chart image
     * @param {string} filename - Download filename
     */
    downloadChart(chartPath, filename = 'chart.png') {
        const apiBase = window.API_BASE.replace('/api', '');
        const fullUrl = `${apiBase}/${chartPath}`;

        const link = document.createElement('a');
        link.href = fullUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        if (typeof showToastSuccess === 'function') {
            showToastSuccess(`Downloading ${filename}...`);
        }
    },

    /**
     * Add download button to chart container
     * @param {string} chartId - Chart element ID
     * @param {string} chartPath - Path to chart image
     * @param {string} filename - Download filename
     */
    addDownloadButton(chartId, chartPath, filename = 'chart.png') {
        const chartElement = document.getElementById(chartId);
        if (!chartElement) return;

        const container = chartElement.closest('.card-body') || chartElement.parentElement;
        if (!container) return;

        // Check if button already exists
        if (container.querySelector('.chart-download-btn')) return;

        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-secondary chart-download-btn mt-3';
        button.innerHTML = 'ðŸ“¥ Download Chart';
        button.onclick = () => this.downloadChart(chartPath, filename);

        container.appendChild(button);
    },

    /**
     * =====================================================
     * CHART METADATA
     * =====================================================
     */

    /**
     * Display chart metadata (dimensions, format, size)
     * @param {string} chartPath - Path to chart image
     * @param {string} containerId - Container for metadata
     */
    async displayChartMetadata(chartPath, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        try {
            const img = new Image();
            const apiBase = window.API_BASE.replace('/api', '');
            const fullUrl = `${apiBase}/${chartPath}`;

            img.onload = () => {
                const metadata = `
                    <div class="chart-metadata text-sm text-gray-600 mt-2">
                        <strong>Dimensions:</strong> ${img.width} Ã— ${img.height}px<br>
                        <strong>Format:</strong> ${this.getImageFormat(chartPath)}<br>
                        <strong>Path:</strong> <code>${chartPath}</code>
                    </div>
                `;
                container.innerHTML += metadata;
            };

            img.src = fullUrl;
        } catch (error) {
            console.error('Error loading chart metadata:', error);
        }
    },

    /**
     * Get image format from file path
     * @param {string} path - File path
     * @returns {string} Image format (PNG, JPG, etc.)
     */
    getImageFormat(path) {
        const ext = path.split('.').pop().toUpperCase();
        return ext === 'JPG' ? 'JPEG' : ext;
    },

    /**
     * =====================================================
     * ERROR HANDLING
     * =====================================================
     */

    /**
     * Show placeholder when chart fails to load
     * @param {string} elementId - Chart element ID
     * @param {string} message - Error message
     */
    showChartError(elementId, message = 'Chart not available') {
        const element = document.getElementById(elementId);
        if (!element) return;

        const container = element.closest('.card-body') || element.parentElement;
        if (!container) return;

        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-6xl mb-4">ðŸ“Š</div>
                <p class="text-gray-600">${message}</p>
            </div>
        `;
    },

    /**
     * Animate chart element on load
     * @param {string} elementId - Chart element ID
     */
    animateChart(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;

        // Add chart-container class for animation
        if (!element.classList.contains('chart-container')) {
            element.classList.add('chart-container');
        }

        // Trigger fade-in animation
        element.style.opacity = '0';
        element.style.transform = 'scale(0.95)';

        setTimeout(() => {
            element.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            element.style.opacity = '1';
            element.style.transform = 'scale(1)';
        }, 50);
    }
};

// Initialize chart service
document.addEventListener('DOMContentLoaded', () => {
    console.log('âœ… charts.js loaded - Chart service ready');
});

// Export for use in other scripts
window.ChartService = ChartService;
