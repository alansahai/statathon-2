<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Learning - StatFlow AI</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>

<body>
    <!-- Navbar Component -->
    <div data-include="components/navbar.html"></div>

    <!-- Steps Indicator -->
    <div data-include="components/steps.html"></div>

    <div class="container">
        <div class="hero text-center mb-6">
            <h1>ü§ñ Machine Learning Analysis</h1>
            <p>Train predictive models and analyze feature importance</p>
        </div>

        <!-- File Info -->
        <div class="file-info"></div>

        <div class="card">
            <h2>ML Model Configuration</h2>
            <p class="text-muted mb-4">Configure and train a machine learning model</p>

            <div class="form-group mb-4">
                <label for="targetVariable">Target Variable:</label>
                <select id="targetVariable" class="form-control">
                    <option value="">Select target variable...</option>
                </select>
            </div>

            <div class="form-group mb-4">
                <label for="mlTask">Task Type:</label>
                <select id="mlTask" class="form-control">
                    <option value="classification">Classification</option>
                    <option value="regression">Regression</option>
                </select>
            </div>

            <div class="form-group mb-4">
                <label for="mlModel">Model:</label>
                <select id="mlModel" class="form-control">
                    <option value="random_forest">Random Forest</option>
                    <option value="xgboost">XGBoost</option>
                    <option value="logistic_regression">Logistic Regression</option>
                    <option value="linear_regression">Linear Regression</option>
                </select>
            </div>

            <div class="form-group mb-4">
                <label>
                    <input type="checkbox" id="autoFeatureSelection" checked>
                    Automatic Feature Selection
                </label>
                <small class="text-muted d-block">Automatically select best features using correlation analysis</small>
            </div>

            <button id="trainModelBtn" class="btn btn-primary btn-block">
                ü§ñ Train Model
            </button>
        </div>

        <div id="mlResults" class="mt-6" style="display: none;">
            <div class="card">
                <h2>Model Performance</h2>
                <div id="mlMetrics"></div>
            </div>

            <div class="card mt-4">
                <h2>Feature Importance</h2>
                <div id="featureImportance"></div>
            </div>
        </div>

        <div class="actions mt-6">
            <button class="btn btn-secondary" onclick="history.back()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="goTo('insight.html')">Continue to Insights ‚Üí</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p class="mt-3">Training model...</p>
        </div>
    </div>

    <script src="assets/api.js"></script>
    <script src="assets/app.js"></script>
    <script src="assets/pipeline.js"></script>
    <script>
        let allFileIds = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Check for file IDs
            if (!requireFileIds()) return;

            allFileIds = ApiService.getFileIds();
            PipelineService.displayFileInfo();

            // Load columns for first file
            try {
                const columns = await ApiService.getColumns(allFileIds[0]);
                const targetSelect = document.getElementById('targetVariable');

                columns.forEach(col => {
                    const option = new Option(col, col);
                    targetSelect.add(option);
                });
            } catch (error) {
                console.error('Error loading columns:', error);
                showToastError('Failed to load columns');
            }

            // Train model button handler
            document.getElementById('trainModelBtn').addEventListener('click', async () => {
                const targetVariable = document.getElementById('targetVariable').value;
                const taskType = document.getElementById('mlTask').value;
                const modelType = document.getElementById('mlModel').value;
                const autoFeatures = document.getElementById('autoFeatureSelection').checked;

                if (!targetVariable) {
                    showToastError('Please select a target variable');
                    return;
                }

                try {
                    showLoader('Training model...');
                    setProgress(20, 'Preparing data...');

                    const response = await ApiService.trainMLModel(allFileIds[0], {
                        target: targetVariable,
                        task: taskType,
                        model: modelType,
                        auto_features: autoFeatures
                    });

                    setProgress(100, 'Model trained!');
                    hideLoader();
                    showToastSuccess('Model trained successfully!');

                    // Display results
                    document.getElementById('mlResults').style.display = 'block';

                    const metricsHtml = taskType === 'classification' ? `
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value">${(response.accuracy * 100).toFixed(2)}%</div>
                                <div class="metric-label">Accuracy</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${(response.precision * 100).toFixed(2)}%</div>
                                <div class="metric-label">Precision</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${(response.recall * 100).toFixed(2)}%</div>
                                <div class="metric-label">Recall</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${(response.f1_score * 100).toFixed(2)}%</div>
                                <div class="metric-label">F1 Score</div>
                            </div>
                        </div>
                    ` : `
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value">${response.r2_score?.toFixed(4) || 'N/A'}</div>
                                <div class="metric-label">R¬≤ Score</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${response.mae?.toFixed(2) || 'N/A'}</div>
                                <div class="metric-label">MAE</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${response.rmse?.toFixed(2) || 'N/A'}</div>
                                <div class="metric-label">RMSE</div>
                            </div>
                        </div>
                    `;

                    document.getElementById('mlMetrics').innerHTML = metricsHtml;

                    // Display feature importance
                    if (response.feature_importance) {
                        const features = Object.entries(response.feature_importance)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10);

                        const featureHtml = features.map(([name, importance]) => `
                            <div class="feature-bar">
                                <div class="feature-name">${name}</div>
                                <div class="feature-importance-bar">
                                    <div class="feature-importance-fill" style="width: ${importance * 100}%"></div>
                                </div>
                                <div class="feature-value">${(importance * 100).toFixed(1)}%</div>
                            </div>
                        `).join('');

                        document.getElementById('featureImportance').innerHTML = featureHtml;
                    }

                    markStepComplete?.('ml');
                } catch (error) {
                    console.error('ML training error:', error);
                    hideLoader?.();
                    showToastError?.('Model training failed: ' + error.message);
                }
            });
        });
    </script>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
        <button id="backBtn" class="btn btn-secondary">‚Üê Previous Step</button>
        <button id="continueBtn" class="btn btn-primary">Continue ‚Üí</button>
    </div>

    <script src="assets/workflow.js"></script>
    <script src="assets/ui_helpers.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileId = WorkflowService?.getFileId();
            if (fileId && typeof UIHelper !== 'undefined') {
                UIHelper.renderProgressTimeline?.('ml');
                UIHelper.renderBreadcrumbs?.('ml.html');
                UIHelper.enableBackButton?.(() => WorkflowService.goToForecasting(fileId));
                UIHelper.enableContinueButton?.(() => WorkflowService.goToDashboard(fileId));
            }
        });
    </script>

    <!-- AI Assistant Integration -->
    <script src="assets/assistant.js"></script>
    <script>
        (async () => {
            await UIHelper.insertAssistantComponent();
            if (window.Assistant) Assistant.init();
        })();
    </script>
</body>

</html>